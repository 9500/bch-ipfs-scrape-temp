---
import MainLayout from '../layouts/MainLayout.astro';
import { getChaingraphData } from '../lib/chaingraph';

let data = null;
let error = null;

try {
	data = await getChaingraphData();
} catch (e: any) {
	error = e.message || 'Failed to connect to Chaingraph server';
}
---

<MainLayout title="Chaingraph">
	<h2>Chaingraph Indexer Status</h2>

	{error ? (
		<section class="error-section">
			<h3>‚ö†Ô∏è Error</h3>
			<p class="error-message">{error}</p>
			<p class="error-detail">Unable to fetch data from Chaingraph at http://192.168.88.105:8088/graphql</p>
		</section>
	) : (
		<>
			<section class="status-section">
				<h3>Chain Tip Information</h3>
				<div class="info-grid">
					<div class="info-card">
						<span class="info-label">Block Height</span>
						<span class="info-value highlight">{data.blockHeight.toLocaleString()}</span>
					</div>
					<div class="info-card">
						<span class="info-label">Transactions in Block</span>
						<span class="info-value">{data.transactionsInBlock.toLocaleString()}</span>
					</div>
					<div class="info-card">
						<span class="info-label">Total Transactions</span>
						<span class="info-value">{data.totalTransactions.toLocaleString()}</span>
					</div>
				</div>
			</section>

			<section class="status-section">
				<h3>Latest Block Details</h3>
				<div class="detail-list">
					<div class="detail-item">
						<span class="detail-label">Height:</span>
						<span class="detail-value">{data.blockHeight.toLocaleString()}</span>
					</div>
					<div class="detail-item">
						<span class="detail-label">Hash (preview):</span>
						<span class="detail-value">{data.blockHash}</span>
					</div>
					<div class="detail-item">
						<span class="detail-label">Timestamp:</span>
						<span class="detail-value">{data.timestamp}</span>
					</div>
				</div>
			</section>

			<section class="status-section">
				<h3>Statistics</h3>
				<div class="stats-grid">
					<div class="stat-card">
						<div class="stat-icon">üìä</div>
						<div class="stat-content">
							<span class="stat-label">Total Indexed Transactions</span>
							<span class="stat-value">{data.totalTransactions.toLocaleString()}</span>
						</div>
					</div>
					<div class="stat-card">
						<div class="stat-icon">üîó</div>
						<div class="stat-content">
							<span class="stat-label">Current Block Transactions</span>
							<span class="stat-value">{data.transactionsInBlock.toLocaleString()}</span>
						</div>
					</div>
				</div>
			</section>

			<div class="refresh-note">
				<p>üí° Data fetched in real-time via GraphQL. Refresh the page to get updated information.</p>
			</div>
		</>
	)}
</MainLayout>

<style>
	.error-section {
		background: #3d1f1f;
		border: 1px solid #5c2828;
		border-left: 4px solid #d32f2f;
		padding: 24px;
		border-radius: 8px;
		margin-bottom: 24px;
	}

	.error-section h3 {
		margin-top: 0;
		color: #ff6b6b;
	}

	.error-message {
		font-size: 16px;
		color: #ffcdd2;
		margin-bottom: 8px;
	}

	.error-detail {
		font-size: 14px;
		color: #a0a0a0;
		margin: 0;
	}

	.status-section {
		background: #2d2d2d;
		padding: 24px;
		border-radius: 8px;
		border: 1px solid #3a3a3a;
		margin-bottom: 24px;
	}

	.status-section h3 {
		margin-top: 0;
		margin-bottom: 20px;
		color: #ffffff;
		font-size: 18px;
	}

	.info-grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
		gap: 16px;
	}

	.info-card {
		background: #1a1a1a;
		padding: 20px;
		border-radius: 6px;
		border: 1px solid #3a3a3a;
		display: flex;
		flex-direction: column;
		gap: 8px;
	}

	.info-label {
		font-size: 12px;
		color: #a0a0a0;
		text-transform: uppercase;
		letter-spacing: 0.5px;
	}

	.info-value {
		font-size: 24px;
		font-weight: 600;
		color: #e0e0e0;
	}

	.info-value.highlight {
		color: #667eea;
	}

	.detail-list {
		display: flex;
		flex-direction: column;
		gap: 12px;
	}

	.detail-item {
		background: #1a1a1a;
		padding: 16px;
		border-radius: 6px;
		border: 1px solid #3a3a3a;
		display: flex;
		justify-content: space-between;
		align-items: center;
	}

	.detail-label {
		font-size: 14px;
		color: #a0a0a0;
		font-weight: 500;
	}

	.detail-value {
		font-size: 14px;
		color: #e0e0e0;
		font-family: 'Courier New', monospace;
	}

	.stats-grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
		gap: 16px;
	}

	.stat-card {
		background: #1a1a1a;
		padding: 20px;
		border-radius: 6px;
		border: 1px solid #3a3a3a;
		display: flex;
		align-items: center;
		gap: 16px;
	}

	.stat-icon {
		font-size: 32px;
	}

	.stat-content {
		display: flex;
		flex-direction: column;
		gap: 4px;
	}

	.stat-label {
		font-size: 12px;
		color: #a0a0a0;
		text-transform: uppercase;
	}

	.stat-value {
		font-size: 20px;
		font-weight: 600;
		color: #667eea;
	}

	.refresh-note {
		background: #2d2d2d;
		border: 1px solid #3a3a3a;
		border-radius: 8px;
		padding: 16px;
		text-align: center;
	}

	.refresh-note p {
		margin: 0;
		color: #a0a0a0;
		font-size: 14px;
	}
</style>
