---
import MainLayout from '../layouts/MainLayout.astro';
import { getChaingraphData } from '../lib/chaingraph';

let data = null;
let error = null;

try {
	data = await getChaingraphData();
} catch (e: any) {
	error = e.message || 'Failed to connect to Chaingraph server';
}

// Helper function to format hash from byte array
function formatHash(hash: string): string {
	if (!hash) return 'N/A';
	// Remove \x prefix and convert to readable format
	return hash.replace(/\\x/g, '').substring(0, 16) + '...';
}

// Helper function to format timestamp
function formatTimestamp(ts: string): string {
	if (!ts) return 'N/A';
	const date = new Date(ts);
	return date.toLocaleString();
}

// Helper function to format satoshis to BCH
function formatBCH(satoshis: string | number): string {
	const sats = typeof satoshis === 'string' ? parseInt(satoshis) : satoshis;
	return (sats / 100000000).toFixed(8) + ' BCH';
}
---

<MainLayout title="Chaingraph">
	<div class="header-with-status">
		<h2>Chaingraph Mempool Monitor</h2>
		<div id="connection-status" class="status-badge disconnected">
			<span class="status-dot"></span>
			<span class="status-text">Connecting...</span>
		</div>
	</div>

	{error ? (
		<section class="error-section">
			<h3>‚ö†Ô∏è Error</h3>
			<p class="error-message">{error}</p>
			<p class="error-detail">Unable to fetch data from Chaingraph at http://192.168.88.105:8088/v1/graphql</p>
		</section>
	) : (
		<>
			<section class="status-section">
				<h3>Node Information</h3>
				<div class="info-grid">
					<div class="info-card">
						<span class="info-label">Node Name</span>
						<span class="info-value" id="node-name">{data.nodeName}</span>
					</div>
					<div class="info-card">
						<span class="info-label">User Agent</span>
						<span class="info-value small" id="user-agent">{data.userAgent}</span>
					</div>
					<div class="info-card">
						<span class="info-label">Mempool Transactions</span>
						<span class="info-value highlight" id="mempool-count">{data.unconfirmedCount.toLocaleString()}</span>
					</div>
				</div>
			</section>

			<section class="status-section">
				<h3>Recent Mempool Transactions (Last 5)</h3>
				<div id="transactions-container">
				{data.recentTransactions.length === 0 ? (
					<p class="no-data">No recent transactions in mempool</p>
				) : (
					<div class="transactions-list" id="transactions-list">
						{data.recentTransactions.map((tx: any) => (
							<div class="transaction-card">
								<div class="tx-header">
									<span class="tx-hash">{formatHash(tx.transaction.hash)}</span>
									<span class="tx-time">{formatTimestamp(tx.validated_at)}</span>
								</div>
								<div class="tx-details">
									<div class="tx-detail">
										<span class="label">Inputs:</span>
										<span class="value">{tx.transaction.input_count}</span>
									</div>
									<div class="tx-detail">
										<span class="label">Outputs:</span>
										<span class="value">{tx.transaction.output_count}</span>
									</div>
									<div class="tx-detail">
										<span class="label">Value:</span>
										<span class="value">{formatBCH(tx.transaction.output_value_satoshis)}</span>
									</div>
									<div class="tx-detail">
										<span class="label">Size:</span>
										<span class="value">{parseInt(tx.transaction.size_bytes).toLocaleString()} bytes</span>
									</div>
								</div>
							</div>
						))}
					</div>
				)}
				</div>
			</section>

			<div class="refresh-note">
				<p>üí° Live updates enabled via GraphQL subscription. Data refreshes automatically.</p>
			</div>
		</>
	)}
</MainLayout>

<script>
	import { createClient } from 'graphql-ws';

	const GRAPHQL_WS_URL = import.meta.env.PUBLIC_CHAINGRAPH_WS_URL;

	// Helper functions (mirroring server-side)
	function formatHash(hash) {
		if (!hash) return 'N/A';
		return hash.replace(/\\x/g, '').substring(0, 16) + '...';
	}

	function formatTimestamp(ts) {
		if (!ts) return 'N/A';
		const date = new Date(ts);
		return date.toLocaleString();
	}

	function formatBCH(satoshis) {
		const sats = typeof satoshis === 'string' ? parseInt(satoshis) : satoshis;
		return (sats / 100000000).toFixed(8) + ' BCH';
	}

	// Update connection status
	function setConnectionStatus(connected) {
		const statusEl = document.getElementById('connection-status');
		const statusText = statusEl.querySelector('.status-text');

		if (connected) {
			statusEl.classList.remove('disconnected');
			statusEl.classList.add('connected');
			statusText.textContent = 'Live';
		} else {
			statusEl.classList.remove('connected');
			statusEl.classList.add('disconnected');
			statusText.textContent = 'Disconnected';
		}
	}

	// Update node information
	function updateNodeInfo(nodeData) {
		const nodeName = document.getElementById('node-name');
		const userAgent = document.getElementById('user-agent');
		const mempoolCount = document.getElementById('mempool-count');

		if (nodeName) nodeName.textContent = nodeData.name;
		if (userAgent) userAgent.textContent = nodeData.user_agent;
		if (mempoolCount) {
			const count = parseInt(nodeData.unconfirmed_transaction_count) || 0;
			mempoolCount.textContent = count.toLocaleString();
		}
	}

	// Update transactions list
	function updateTransactions(transactions) {
		const container = document.getElementById('transactions-container');
		if (!container) return;

		if (transactions.length === 0) {
			container.innerHTML = '<p class="no-data">No recent transactions in mempool</p>';
			return;
		}

		// Create transaction cards with proper styling
		const transactionCards = transactions.map(tx => {
			const card = document.createElement('div');
			card.className = 'transaction-card';

			const header = document.createElement('div');
			header.className = 'tx-header';

			const hashSpan = document.createElement('span');
			hashSpan.className = 'tx-hash';
			hashSpan.textContent = formatHash(tx.transaction.hash);

			const timeSpan = document.createElement('span');
			timeSpan.className = 'tx-time';
			timeSpan.textContent = formatTimestamp(tx.validated_at);

			header.appendChild(hashSpan);
			header.appendChild(timeSpan);

			const details = document.createElement('div');
			details.className = 'tx-details';

			// Create detail items
			const detailItems = [
				{ label: 'Inputs:', value: tx.transaction.input_count },
				{ label: 'Outputs:', value: tx.transaction.output_count },
				{ label: 'Value:', value: formatBCH(tx.transaction.output_value_satoshis) },
				{ label: 'Size:', value: parseInt(tx.transaction.size_bytes).toLocaleString() + ' bytes' }
			];

			detailItems.forEach(item => {
				const detailDiv = document.createElement('div');
				detailDiv.className = 'tx-detail';

				const labelSpan = document.createElement('span');
				labelSpan.className = 'label';
				labelSpan.textContent = item.label;

				const valueSpan = document.createElement('span');
				valueSpan.className = 'value';
				valueSpan.textContent = item.value;

				detailDiv.appendChild(labelSpan);
				detailDiv.appendChild(valueSpan);
				details.appendChild(detailDiv);
			});

			card.appendChild(header);
			card.appendChild(details);

			return card;
		});

		// Clear container and add new cards
		container.innerHTML = '';
		const listDiv = document.createElement('div');
		listDiv.className = 'transactions-list';
		transactionCards.forEach(card => listDiv.appendChild(card));
		container.appendChild(listDiv);
	}

	// Setup GraphQL subscription
	function setupSubscription() {
		const client = createClient({
			url: GRAPHQL_WS_URL,
			retryAttempts: Infinity,
			shouldRetry: () => true,
		});

		const subscription = client.subscribe(
			{
				query: `
					subscription MonitorMempools {
						node {
							name
							user_agent
							unconfirmed_transaction_count
							unconfirmed_transactions(
								limit: 5,
								order_by: { validated_at: desc }
							) {
								validated_at
								transaction {
									hash
									input_count
									output_count
									output_value_satoshis
									size_bytes
								}
							}
						}
					}
				`,
			},
			{
				next: (data) => {
					console.log('Received subscription data:', data);

					if (data.data && data.data.node && data.data.node.length > 0) {
						const nodeData = data.data.node[0];
						updateNodeInfo(nodeData);
						updateTransactions(nodeData.unconfirmed_transactions || []);
						setConnectionStatus(true);
					}
				},
				error: (error) => {
					console.error('Subscription error:', error);
					setConnectionStatus(false);
				},
				complete: () => {
					console.log('Subscription complete');
					setConnectionStatus(false);
				},
			}
		);

		return () => subscription();
	}

	// Start subscription when page loads
	if (typeof window !== 'undefined') {
		const unsubscribe = setupSubscription();

		// Clean up on page unload
		window.addEventListener('beforeunload', unsubscribe);
	}
</script>

<style>
	.error-section {
		background: #3d1f1f;
		border: 1px solid #5c2828;
		border-left: 4px solid #d32f2f;
		padding: 24px;
		border-radius: 8px;
		margin-bottom: 24px;
	}

	.error-section h3 {
		margin-top: 0;
		color: #ff6b6b;
	}

	.error-message {
		font-size: 16px;
		color: #ffcdd2;
		margin-bottom: 8px;
	}

	.error-detail {
		font-size: 14px;
		color: #a0a0a0;
		margin: 0;
	}

	.status-section {
		background: #2d2d2d;
		padding: 24px;
		border-radius: 8px;
		border: 1px solid #3a3a3a;
		margin-bottom: 24px;
	}

	.status-section h3 {
		margin-top: 0;
		margin-bottom: 20px;
		color: #ffffff;
		font-size: 18px;
	}

	.info-grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
		gap: 16px;
	}

	.info-card {
		background: #1a1a1a;
		padding: 20px;
		border-radius: 6px;
		border: 1px solid #3a3a3a;
		display: flex;
		flex-direction: column;
		gap: 8px;
	}

	.info-label {
		font-size: 12px;
		color: #a0a0a0;
		text-transform: uppercase;
		letter-spacing: 0.5px;
	}

	.info-value {
		font-size: 24px;
		font-weight: 600;
		color: #e0e0e0;
		word-break: break-all;
	}

	.info-value.small {
		font-size: 14px;
		font-family: 'Courier New', monospace;
	}

	.info-value.highlight {
		color: #667eea;
	}

	.no-data {
		text-align: center;
		color: #a0a0a0;
		padding: 32px;
		font-style: italic;
	}

	:global(.transactions-list) {
		display: flex;
		flex-direction: column;
		gap: 16px;
	}

	:global(.transaction-card) {
		background: #1a1a1a;
		border: 1px solid #3a3a3a;
		border-radius: 6px;
		padding: 16px;
		transition: all 0.2s ease;
	}

	:global(.transaction-card:hover) {
		border-color: #667eea;
		background: #222222;
	}

	:global(.tx-header) {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 12px;
		padding-bottom: 12px;
		border-bottom: 1px solid #3a3a3a;
		flex-wrap: wrap;
		gap: 8px;
	}

	:global(.tx-hash) {
		font-family: 'Courier New', monospace;
		color: #667eea;
		font-size: 14px;
		font-weight: 600;
	}

	:global(.tx-time) {
		font-size: 12px;
		color: #a0a0a0;
	}

	:global(.tx-details) {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
		gap: 12px;
	}

	:global(.tx-detail) {
		display: flex;
		flex-direction: column;
		gap: 4px;
	}

	:global(.tx-detail .label) {
		font-size: 11px;
		color: #a0a0a0;
		text-transform: uppercase;
		letter-spacing: 0.5px;
	}

	:global(.tx-detail .value) {
		font-size: 14px;
		color: #e0e0e0;
		font-weight: 500;
	}

	.refresh-note {
		background: #2d2d2d;
		border: 1px solid #3a3a3a;
		border-radius: 8px;
		padding: 16px;
		text-align: center;
	}

	.refresh-note p {
		margin: 0;
		color: #a0a0a0;
		font-size: 14px;
	}

	.header-with-status {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 24px;
		flex-wrap: wrap;
		gap: 16px;
	}

	.header-with-status h2 {
		margin: 0;
	}

	.status-badge {
		display: flex;
		align-items: center;
		gap: 8px;
		padding: 8px 16px;
		border-radius: 20px;
		font-size: 14px;
		font-weight: 500;
		transition: all 0.3s ease;
	}

	.status-badge.connected {
		background: rgba(76, 175, 80, 0.2);
		border: 1px solid rgba(76, 175, 80, 0.5);
		color: #4caf50;
	}

	.status-badge.disconnected {
		background: rgba(158, 158, 158, 0.2);
		border: 1px solid rgba(158, 158, 158, 0.5);
		color: #9e9e9e;
	}

	.status-dot {
		width: 8px;
		height: 8px;
		border-radius: 50%;
		animation: pulse 2s infinite;
	}

	.status-badge.connected .status-dot {
		background: #4caf50;
	}

	.status-badge.disconnected .status-dot {
		background: #9e9e9e;
		animation: none;
	}

	@keyframes pulse {
		0%, 100% {
			opacity: 1;
		}
		50% {
			opacity: 0.5;
		}
	}
</style>
